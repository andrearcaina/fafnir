services:
    db:
        build:
            context: ../../
            dockerfile: build/docker/postgres.Dockerfile
        restart: always
        environment:
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_USER: ${POSTGRES_USER}
        volumes:
            - pgdata:/var/lib/postgresql
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 60s
        ports:
            - "127.0.0.1:${DB_PORT}:5432"
        networks:
            - fafnir-network

    api-gateway:
        build:
            context: ../../
            dockerfile: build/docker/go-services.Dockerfile
            target: ${BUILD_TARGET:-production}
            args:
                SERVICE_NAME: api-gateway
        environment:
            - SERVICE_NAME=api-gateway
            - SERVICE_PORT=8080
            - JWT_SECRET_KEY=${JWT_SECRET_KEY}
        volumes:
            - ../../src/api-gateway:/app/src/api-gateway:cached
            - ../../src/shared:/app/src/shared:cached
        depends_on:
            user-service:
                condition: service_started
            security-service:
                condition: service_started
            stock-service:
                condition: service_started
            auth-service:
                condition: service_started
        ports:
            - "127.0.0.1:8080:8080"
        networks:
            - fafnir-network

    auth-service:
        build:
            context: ../../
            dockerfile: build/docker/go-services.Dockerfile
            target: ${BUILD_TARGET:-production}
            args:
                SERVICE_NAME: auth-service
        environment:
            - SERVICE_NAME=auth-service
            - SERVICE_PORT=8081
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - AUTH_DB=${AUTH_DB}
            - DB_HOST=${DB_HOST_DOCKER}
            - DB_PORT=${DB_PORT}
            - JWT_SECRET_KEY=${JWT_SECRET_KEY}
            - NATS_HOST=${NATS_HOST_DOCKER}
            - NATS_PORT=${NATS_PORT}
        volumes:
            - ../../src/auth-service:/app/src/auth-service:cached
            - ../../src/shared:/app/src/shared:cached
        depends_on:
            db:
                condition: service_healthy
        networks:
            - fafnir-network

    security-service:
        build:
            context: ../../
            dockerfile: build/docker/go-services.Dockerfile
            target: ${BUILD_TARGET:-production}
            args:
                SERVICE_NAME: security-service
        environment:
            - SERVICE_NAME=security-service
            - SERVICE_PORT=8082
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - SECURITY_DB=${SECURITY_DB}
            - DB_HOST=${DB_HOST_DOCKER}
            - DB_PORT=${DB_PORT}
            - NATS_HOST=${NATS_HOST_DOCKER}
            - NATS_PORT=${NATS_PORT}
        volumes:
            - ../../src/security-service:/app/src/security-service:cached
            - ../../src/shared:/app/src/shared:cached
        depends_on:
            db:
                condition: service_healthy
        networks:
            - fafnir-network

    user-service:
        build:
            context: ../../
            dockerfile: build/docker/go-services.Dockerfile
            target: ${BUILD_TARGET:-production}
            args:
                SERVICE_NAME: user-service
        environment:
            - SERVICE_NAME=user-service
            - SERVICE_PORT=8083
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - USER_DB=${USER_DB}
            - DB_HOST=${DB_HOST_DOCKER}
            - DB_PORT=${DB_PORT}
            - NATS_HOST=${NATS_HOST_DOCKER}
            - NATS_PORT=${NATS_PORT}
        volumes:
            - ../../src/user-service:/app/src/user-service:cached
            - ../../src/shared:/app/src/shared:cached
        depends_on:
            db:
                condition: service_healthy
        networks:
            - fafnir-network

    stock-service:
        build:
            context: ../../
            dockerfile: build/docker/go-services.Dockerfile
            target: ${BUILD_TARGET:-production}
            args:
                SERVICE_NAME: stock-service
        environment:
            - SERVICE_NAME=stock-service
            - SERVICE_PORT=8084
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - STOCK_DB=${STOCK_DB}
            - DB_HOST=${DB_HOST_DOCKER}
            - DB_PORT=${DB_PORT}
            - REDIS_HOST=redis
            - REDIS_PORT=6379
            - FMP_API_KEY=${FMP_API_KEY}
        volumes:
            - ../../src/stock-service:/app/src/stock-service:cached
            - ../../src/shared:/app/src/shared:cached
        depends_on:
            db:
                condition: service_healthy
        networks:
            - fafnir-network

    nats:
        image: "nats:latest"
        container_name: fafnir-nats
        restart: always
        networks:
            - fafnir-network

    redis:
        image: "redis:latest"
        container_name: fafnir-stock-redis
        restart: always
        networks:
            - fafnir-network

volumes:
    pgdata:

networks:
    fafnir-network:
        driver: bridge
